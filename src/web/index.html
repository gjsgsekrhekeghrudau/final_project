<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interview Coach (LLM)</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#0f172a;
      --panel2:#111b33;
      --text:#e5e7eb;
      --muted:#a3a3a3;
      --border:rgba(255,255,255,.08);
      --bubbleUser:#1f2a44;
      --bubbleAi:#0f172a;
      --accent:#22c55e;
      --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:16px;
      --maxw: 860px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7f8;
        --panel:#ffffff;
        --panel2:#fafafa;
        --text:#0f172a;
        --muted:#6b7280;
        --border:rgba(0,0,0,.08);
        --bubbleUser:#e8f0ff;
        --bubbleAi:#ffffff;
        --shadow: 0 18px 60px rgba(0,0,0,.12);
      }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 800px at 50% -10%, rgba(34,197,94,.15), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(59,130,246,.12), transparent 60%),
                  var(--bg);
    }

    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    /* Top bar */
    .topbar{
      width:100%;
      position:sticky;
      top:0;
      z-index:5;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:var(--maxw);
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(34,197,94,.9), rgba(59,130,246,.7));
      box-shadow: 0 10px 30px rgba(34,197,94,.18);
    }
    .brand h1{
      margin:0;
      font-size:14px;
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .brand-text{ min-width:0; }

    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,.07); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      border-color: rgba(34,197,94,.4);
      background: rgba(34,197,94,.12);
    }
    .btn.primary:hover{ background: rgba(34,197,94,.16); }

    .btn.danger{
      border-color: rgba(239,68,68,.45);
      background: rgba(239,68,68,.10);
    }

    /* Chat area */
    .shell{
      width:100%;
      max-width:var(--maxw);
      padding: 10px 16px 0;
      flex:1;
      display:flex;
      flex-direction:column;
    }

    .quickbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      padding:10px 0 6px;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .chip:hover{ background:rgba(255,255,255,.07); }
    .chip b{ font-weight:700; }
    .chip .dot{
      width:6px;height:6px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }

    .chat{
      flex:1;
      overflow:auto;
      padding: 8px 0 18px;
      scroll-behavior:smooth;
    }
    .chat::-webkit-scrollbar{ width:10px; }
    .chat::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius:999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }

    .msg{
      display:flex;
      gap:12px;
      margin: 12px 0;
      align-items:flex-start;
    }
    .avatar{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;
      flex:0 0 auto;
      overflow:hidden;
    }
    .avatar.user{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.25); }
    .avatar.ai{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.25); }

    .bubble{
      max-width: 100%;
      padding: 12px 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bubbleAi);
      box-shadow: 0 8px 25px rgba(0,0,0,.12);
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.user{ background: var(--bubbleUser); }
    .meta{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }
    .badge{
      font-family: var(--mono);
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .score{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color: var(--text);
    }
    .score.low{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
    }

    /* Composer */
    .composer-wrap{
      width:100%;
      position:sticky;
      bottom:0;
      z-index:6;
      padding: 12px 0 18px;
      background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
    }
    @media (prefers-color-scheme: light){
      .composer-wrap{ background: linear-gradient(to top, rgba(247,247,248,.96), rgba(247,247,248,0)); }
      .topbar{ background: linear-gradient(to bottom, rgba(247,247,248,.95), rgba(247,247,248,0)); }
    }

    .composer{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding: 10px 10px;
      border-radius: 18px;
      background: var(--panel);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
    }
    textarea{
      width:100%;
      border:0;
      outline:none;
      resize:none;
      background:transparent;
      color:var(--text);
      font-family: var(--sans);
      font-size:14px;
      line-height:1.35;
      max-height: 180px;
      padding: 10px 8px;
    }
    textarea::placeholder{ color: rgba(163,163,163,.85); }

    .send{
      width:44px;height:44px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease;
      flex:0 0 auto;
      user-select:none;
    }
    .send:hover{ background: rgba(34,197,94,.22); }
    .send:active{ transform: translateY(1px); }
    .send[disabled]{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .footer-note{
      text-align:center;
      font-size:12px;
      color:var(--muted);
      padding: 10px 0 0;
    }

    /* Typing indicator */
    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .dot{
      width:6px;height:6px;border-radius:50%;
      background: rgba(163,163,163,.75);
      animation: bounce 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay:.12s; }
    .dot:nth-child(3){ animation-delay:.24s; }
    @keyframes bounce{
      0%, 80%, 100%{ transform: translateY(0); opacity:.65; }
      40%{ transform: translateY(-4px); opacity:1; }
    }

    /* Small screens */
    @media (max-width: 560px){
      .topbar-inner{ padding: 12px 12px; }
      .shell{ padding: 8px 12px 0; }
      .composer{ border-radius:16px; }
      .avatar{ display:none; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brand-text">
            <h1>Interview Coach (LLM)</h1>
            <div class="sub">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è–º: –≤–æ–ø—Ä–æ—Å—ã ‚Üí –æ—Ç–≤–µ—Ç—ã ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Üí –æ—Ü–µ–Ω–∫–∞</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn" id="toggleDemo">–î–µ–º–æ: ON</button>
          <button class="btn danger" id="clearChat">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="shell">
      <div class="quickbar">
        <div class="chip" id="startInterview"><span class="dot"></span><b>–°—Ç–∞—Ä—Ç</b> —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è</div>
        <div class="chip" id="askHint">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
        <div class="chip" id="askSample">üß© –≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç</div>
        <div class="chip" id="askEval">‚úÖ –û—Ü–µ–Ω–∏—Ç—å –º–æ–π –æ—Ç–≤–µ—Ç</div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="composer-wrap">
        <div class="composer" role="group" aria-label="Composer">
          <textarea id="input" rows="1" placeholder="–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç‚Ä¶ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>
          <button class="send" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            <!-- arrow up -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 4l6.5 6.5-1.4 1.4L13 7.8V20h-2V7.8L6.9 11.9 5.5 10.5 12 4z" fill="currentColor"/>
            </svg>
          </button>
        </div>
        <div class="footer-note">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–ø–∏—à–∏ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—à—å –±—ç–∫–µ–Ω–¥ ‚Äî –∑–∞–º–µ–Ω–∏ <span style="font-family:var(--mono)">/api/chat</span>.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Minimal ChatGPT-like UI + Interview helper actions
    // Backend endpoints (optional):
    // POST /api/chat       { messages: [{role,content}], mode, meta } -> { reply }
    // POST /api/evaluate   { question, answer } -> { score, feedback }
    // If no backend, demo mode generates mock answers.
    // ----------------------------

    const elChat = document.getElementById("chat");
    const elInput = document.getElementById("input");
    const elSend = document.getElementById("sendBtn");

    const elClear = document.getElementById("clearChat");
    const elToggleDemo = document.getElementById("toggleDemo");

    const btnStart = document.getElementById("startInterview");
    const btnHint = document.getElementById("askHint");
    const btnSample = document.getElementById("askSample");
    const btnEval = document.getElementById("askEval");

    const LS_KEY = "interview_coach_chat_v1";
    const LS_DEMO = "interview_coach_demo_v1";

    let demoMode = (localStorage.getItem(LS_DEMO) ?? "true") === "true";
    elToggleDemo.textContent = "–î–µ–º–æ: " + (demoMode ? "ON" : "OFF");

    /** @type {{role:"user"|"assistant"|"system", content:string, meta?:any}[]} */
    let messages = loadChat();

    // Seed
    if (messages.length === 0) {
      messages.push({
        role: "assistant",
        content:
`–ü—Ä–∏–≤–µ—Ç! –Ø —Ç—Ä–µ–Ω–∞–∂—ë—Ä —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–π.

‚Ä¢ –ù–∞–ø–∏—à–∏ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù ‚Äî –¥–∞–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å.
‚Ä¢ –ü–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –º–æ–∂–µ—à—å –Ω–∞–∂–∞—Ç—å: ‚Äú–ü–æ–¥—Å–∫–∞–∑–∫–∞‚Äù, ‚Äú–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç‚Äù, ‚Äú–û—Ü–µ–Ω–∏—Ç—å –º–æ–π –æ—Ç–≤–µ—Ç‚Äù.

–° –∫–∞–∫–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ç—Ä–µ–Ω–∏—Ä—É–µ–º—Å—è? (–Ω–∞–ø—Ä–∏–º–µ—Ä: Java, Python, Frontend, DevOps, System Design)`
      });
      saveChat();
    }

    render();

    // Auto-grow textarea
    function autosize(){
      elInput.style.height = "auto";
      elInput.style.height = Math.min(elInput.scrollHeight, 180) + "px";
    }
    elInput.addEventListener("input", autosize);
    autosize();

    // Send by button or Enter
    elSend.addEventListener("click", () => sendFromInput());
    elInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendFromInput();
      }
    });

    // Quick actions
    btnStart.addEventListener("click", () => sendUser("—Å—Ç–∞—Ä—Ç"));
    btnHint.addEventListener("click", () => sendUser("–¥–∞–π –ø–æ–¥—Å–∫–∞–∑–∫—É –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≤–æ–ø—Ä–æ—Å—É"));
    btnSample.addEventListener("click", () => sendUser("–ø–æ–∫–∞–∂–∏ —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –≤–æ–ø—Ä–æ—Å—É"));
    btnEval.addEventListener("click", () => sendUser("–æ—Ü–µ–Ω–∏ –º–æ–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ –∏ –¥–∞–π —Ñ–∏–¥–±–µ–∫"));

    elClear.addEventListener("click", () => {
      messages = [];
      localStorage.removeItem(LS_KEY);
      messages.push({
        role: "assistant",
        content: "–ß–∞—Ç –æ—á–∏—â–µ–Ω. –ù–∞–ø–∏—à–∏ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ."
      });
      saveChat();
      render(true);
    });

    elToggleDemo.addEventListener("click", () => {
      demoMode = !demoMode;
      localStorage.setItem(LS_DEMO, String(demoMode));
      elToggleDemo.textContent = "–î–µ–º–æ: " + (demoMode ? "ON" : "OFF");
      addAssistant(demoMode
        ? "–î–µ–º–æ-—Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω: –æ—Ç–≤–µ—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞)."
        : "–î–µ–º–æ-—Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á—ë–Ω: –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ /api/chat."
      );
    });

    function sendFromInput(){
      const text = elInput.value.trim();
      if (!text) return;
      elInput.value = "";
      autosize();
      sendUser(text);
    }

    function sendUser(text){
      messages.push({ role:"user", content:text });
      saveChat();
      render(true);
      reply(text);
    }

    function addAssistant(text, meta){
      messages.push({ role:"assistant", content:text, meta });
      saveChat();
      render(true);
    }

    function addTyping(){
      const typingMsg = { role:"assistant", content:"__TYPING__" };
      messages.push(typingMsg);
      render(true);
      return () => {
        const idx = messages.indexOf(typingMsg);
        if (idx >= 0) messages.splice(idx, 1);
      };
    }

    async function reply(userText){
      elSend.disabled = true;
      const stopTyping = addTyping();

      try{
        let out;
        if (demoMode) {
          out = await demoLLM(messages, userText);
        } else {
          out = await callBackend(messages);
        }
        stopTyping();
        addAssistant(out.content, out.meta);
      } catch(err){
        stopTyping();
        addAssistant("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å /api/chat –∏–ª–∏ –≤–∫–ª—é—á–∏ –¥–µ–º–æ-—Ä–µ–∂–∏–º.\n\n" + String(err));
      } finally {
        elSend.disabled = false;
      }
    }

    async function callBackend(allMessages){
      const payload = {
        mode: "interview_coach",
        messages: [
          {
            role:"system",
            content:
`–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è–º.
–¢–≤–æ—è —Ü–µ–ª—å: —Å–Ω–∏–∑–∏—Ç—å —Ç—Ä–µ–≤–æ–≥—É, –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –¥–∞–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏, —ç—Ç–∞–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, –∏ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "—Å—Ç–∞—Ä—Ç" ‚Äî –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é. –í–æ–ø—Ä–æ—Å—ã: –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–ø–æ–¥—Å–∫–∞–∑–∫—É" ‚Äî –¥–∞–π 3‚Äì5 –ø—É–Ω–∫—Ç–æ–≤, –Ω–æ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –ø–æ–ª–Ω–æ—Å—Ç—å—é.
–ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç "—ç—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç" ‚Äî –¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.
–ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç "–æ—Ü–µ–Ω–∏" ‚Äî –ø–æ—Å—Ç–∞–≤—å –±–∞–ª–ª 0‚Äì10, –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —É–ª—É—á—à–∏—Ç—å, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é.`
          },
          ...allMessages.filter(m => m.role !== "system")
        ]
      };

      const r = await fetch("/api/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if (!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json();
      // expected: { reply: "...", meta?: {...} }
      return { content: data.reply ?? String(data), meta: data.meta };
    }

    // ----------------------------
    // DEMO LLM (mock)
    // ----------------------------
    const demoState = {
      track: null,
      lastQuestion: null,
      lastUserAnswer: null,
      difficulty: 1
    };

    function pickTrackFromText(t){
      const s = t.toLowerCase();
      if (/(frontend|react|js|javascript|typescript|html|css)/.test(s)) return "Frontend";
      if (/(python|django|flask)/.test(s)) return "Python";
      if (/(java|spring)/.test(s)) return "Java";
      if (/(devops|k8s|kubernetes|docker|ci\/cd)/.test(s)) return "DevOps";
      if (/(system design|–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞|scal|–º–∞—Å—à—Ç–∞–±)/.test(s)) return "System Design";
      return null;
    }

    function scoreAnswer(q, a){
      // very rough heuristic
      const len = (a||"").trim().length;
      let score = 3;
      if (len > 80) score = 5;
      if (len > 180) score = 7;
      if (/(–ø—Ä–∏–º–µ—Ä|–Ω–∞–ø—Ä–∏–º–µ—Ä|case|–ø–æ—Ç–æ–º—É —á—Ç–æ|trade-off|–∫–æ–º–ø—Ä–æ–º–∏—Å—Å)/i.test(a)) score += 1;
      if (/(–Ω–µ –∑–Ω–∞—é|—Ö–∑|–±–µ–∑ –ø–æ–Ω—è—Ç–∏—è)/i.test(a)) score = 2;
      score = Math.max(0, Math.min(10, score));
      return score;
    }

    async function demoLLM(allMessages, userText){
      await new Promise(r => setTimeout(r, 350));

      const t = userText.trim().toLowerCase();

      // track selection
      if (!demoState.track){
        const guessed = pickTrackFromText(userText);
        if (guessed){
          demoState.track = guessed;
          return {
            content: `–û–∫, —Ç—Ä–µ–Ω–∏—Ä—É–µ–º—Å—è –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é **${demoState.track}**.\n–ù–∞–ø–∏—à–∏ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù, –∏ —è –∑–∞–¥–∞–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å.`,
          };
        }
      }

      // store last user answer if last was question
      const lastAssistant = [...allMessages].reverse().find(m => m.role === "assistant" && m.content !== "__TYPING__");
      if (demoState.lastQuestion && lastAssistant && lastAssistant.content.includes(demoState.lastQuestion)){
        demoState.lastUserAnswer = userText;
      }

      if (t === "—Å—Ç–∞—Ä—Ç" || t.includes("—Å—Ç–∞—Ä—Ç")){
        demoState.track = demoState.track || "–û–±—â–µ–µ";
        const q = makeQuestion(demoState.track, demoState.difficulty);
        demoState.lastQuestion = q;
        return {
          content:
`–í–æ–ø—Ä–æ—Å ${demoState.difficulty} —É—Ä–æ–≤–Ω—è (${demoState.track}):

**${q}**

–û—Ç–≤–µ—Ç—å –∫–∞–∫ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏: –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –º–æ–∂–Ω–æ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π (–ø—É–Ω–∫—Ç—ã).`,
        };
      }

      if (t.includes("–ø–æ–¥—Å–∫–∞–∑–∫")){
        if (!demoState.lastQuestion){
          return { content: "–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ‚Äú–°—Ç–∞—Ä—Ç‚Äù, —á—Ç–æ–±—ã —è –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å üôÇ" };
        }
        return {
          content:
`–ü–æ–¥—Å–∫–∞–∑–∫–∞ –∫ –≤–æ–ø—Ä–æ—Å—É:

1) –û–ø—Ä–µ–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
2) –î–∞–π –±–∞–∑–æ–≤–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ + –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ.
3) –ü—Ä–∏–≤–µ–¥–∏ 1 –ø—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏.
4) –ù–∞–∑–æ–≤–∏ 1‚Äì2 —Ç–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏/–ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏.
5) –ï—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ ‚Äî —É–ø–æ–º—è–Ω–∏ trade-offs.`,
        };
      }

      if (t.includes("—ç—Ç–∞–ª–æ–Ω") || t.includes("–ø—Ä–∏–º–µ—Ä") || t.includes("sample")){
        if (!demoState.lastQuestion){
          return { content: "–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–µ–Ω –≤–æ–ø—Ä–æ—Å: –Ω–∞–∂–º–∏ ‚Äú–°—Ç–∞—Ä—Ç‚Äù." };
        }
        return {
          content:
`–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–ø—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã):

‚Ä¢ **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ)
‚Ä¢ **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:** (–∫–æ—Ä–æ—Ç–∫–æ –ø–æ —à–∞–≥–∞–º)
‚Ä¢ **–ì–¥–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç:** (1‚Äì2 —Å—Ü–µ–Ω–∞—Ä–∏—è)
‚Ä¢ **–ü–ª—é—Å—ã/–º–∏–Ω—É—Å—ã:** (trade-offs)
‚Ä¢ **–ü—Ä–∏–º–µ—Ä:** (–º–∞–ª–µ–Ω—å–∫–∏–π –∫–µ–π—Å)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –ø—Ä–∏—à–ª–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç, —è –ø–æ–¥–≥–æ–Ω—é –µ–≥–æ ‚Äú–ø–æ–¥ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ‚Äù.`,
        };
      }

      if (t.includes("–æ—Ü–µ–Ω–∏") || t.includes("–æ—Ü–µ–Ω–∏—Ç—å")){
        if (!demoState.lastQuestion){
          return { content: "–ú–Ω–µ –Ω—É–∂–µ–Ω –≤–æ–ø—Ä–æ—Å –∏ —Ç–≤–æ–π –æ—Ç–≤–µ—Ç. –ù–∞–∂–º–∏ ‚Äú–°—Ç–∞—Ä—Ç‚Äù, –æ—Ç–≤–µ—Ç—å ‚Äî –ø–æ—Ç–æ–º —è –æ—Ü–µ–Ω—é." };
        }
        const a = demoState.lastUserAnswer || "";
        if (!a.trim()){
          return { content: "–Ø –Ω–µ –≤–∏–∂—É —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å. –ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç ‚Äî –∏ —è –æ—Ü–µ–Ω—é üôÇ" };
        }
        const s = scoreAnswer(demoState.lastQuestion, a);
        const meta = { score: s };
        const improved =
`–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–∫–æ—Ä–æ—á–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–µ–µ):
1) –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ/—Å—É—Ç—å.
2) –ö–∞–∫/–ø–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç.
3) –ü—Ä–∏–º–µ—Ä.
4) –†–∏—Å–∫–∏/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.
5) –ò—Ç–æ–≥.`;

        const tips = [
          "–î–æ–±–∞–≤—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä (–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞/—É—á—ë–±—ã).",
          "–°–¥–µ–ª–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É: 3‚Äì5 –ø—É–Ω–∫—Ç–æ–≤.",
          "–ù–∞–∑–æ–≤–∏ trade-off –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ.",
        ].slice(0, s >= 7 ? 2 : 3);

        return {
          content:
`–û—Ü–µ–Ω–∫–∞: **${s}/10**.

–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:
- –¢—ã –¥–∞–ª(–∞) –±–∞–∑–æ–≤—É—é –º—ã—Å–ª—å.

–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å:
- ${tips.join("\n- ")}

${improved}

–•–æ—á–µ—à—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å? –ù–∞–ø–∏—à–∏ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù.`,
          meta
        };
      }

      // default coaching
      // if user gives an answer to last question, nudge to evaluate
      if (demoState.lastQuestion && userText.trim().length > 0 && !/(–ø–æ–¥—Å–∫–∞–∑–∫|—ç—Ç–∞–ª–æ–Ω|–æ—Ü–µ–Ω–∏|—Å—Ç–∞—Ä—Ç)/i.test(userText)) {
        demoState.lastUserAnswer = userText;
        return {
          content:
`–ü—Ä–∏–Ω—è–ª –æ—Ç–≤–µ—Ç ‚úÖ

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å:
‚Ä¢ –Ω–∞–∂–º–∏ ‚Äú–û—Ü–µ–Ω–∏—Ç—å –º–æ–π –æ—Ç–≤–µ—Ç‚Äù ‚Äî –ø–æ—Å—Ç–∞–≤–ª—é –±–∞–ª–ª –∏ –¥–∞–º —Ñ–∏–¥–±–µ–∫
‚Ä¢ ‚Äú–ü–æ–¥—Å–∫–∞–∑–∫–∞‚Äù ‚Äî –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å, —á—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å
‚Ä¢ ‚Äú–≠—Ç–∞–ª–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç‚Äù ‚Äî –ø—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏

–ò–ª–∏ –Ω–∞–ø–∏—à–∏ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.`
        };
      }

      return { content: "–û–∫. –ù–∞–ø–∏—à–∏ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù, —á—Ç–æ–±—ã —è –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å, –∏–ª–∏ –ø—Ä–∏—à–ª–∏ —Ç–µ–º—É/—Å—Ç–µ–∫, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –≥–æ—Ç–æ–≤–∏–º—Å—è." };
    }

    function makeQuestion(track, level){
      const bank = {
        "Frontend": [
          "–ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è event bubbling –æ—Ç capturing? –ö–∞–∫ —ç—Ç–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?",
          "–ß—Ç–æ —Ç–∞–∫–æ–µ Virtual DOM –∏ —á–µ–º –æ–Ω –ø–æ–º–æ–≥–∞–µ—Ç? –ö–∞–∫–∏–µ –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è?",
          "–ö–∞–∫ –±—ã —Ç—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–ª(–∞) —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∏–∑ 10 000 —ç–ª–µ–º–µ–Ω—Ç–æ–≤?"
        ],
        "Python": [
          "–ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è list –æ—Ç tuple –∏ –∫–æ–≥–¥–∞ —á—Ç–æ –≤—ã–±–∏—Ä–∞—Ç—å?",
          "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç GIL –∏ –∫–æ–≥–¥–∞ –æ–Ω –º–µ—à–∞–µ—Ç?",
          "–ö–∞–∫ –±—ã —Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª(–∞) –æ–±—Ä–∞–±–æ—Ç–∫—É 1M —Å—Ç—Ä–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞ –±–µ–∑ OOM?"
        ],
        "Java": [
          "–ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è HashMap –æ—Ç TreeMap? –°–ª–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π?",
          "–ß—Ç–æ —Ç–∞–∫–æ–µ JVM GC –≤ –æ–±—â–∏—Ö —á–µ—Ä—Ç–∞—Ö –∏ –∫–∞–∫–∏–µ –±—ã–≤–∞—é—Ç –ø–∞—É–∑—ã?",
          "–ß—Ç–æ —Ç–∞–∫–æ–µ equals/hashCode –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏ —á—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –µ–≥–æ –Ω–∞—Ä—É—à–∏—Ç—å?"
        ],
        "DevOps": [
          "–ß—Ç–æ —Ç–∞–∫–æ–µ liveness/readiness probes –≤ Kubernetes –∏ –∑–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã?",
          "–ö–∞–∫ –±—ã —Ç—ã –æ–ø–∏—Å–∞–ª(–∞) —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–µ–ø–ª–æ—è blue/green –∏ canary?",
          "–ö–∞–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, –ø–æ—á–µ–º—É —Å–µ—Ä–≤–∏—Å –≤ –ø—Ä–æ–¥–µ —Å—Ç–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ?"
        ],
        "System Design": [
          "–ö–∞–∫ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å—Å—ã–ª–æ–∫? –ö–∞–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã?",
          "–ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ API –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤?",
          "–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å rate limiting –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API?"
        ],
        "–û–±—â–µ–µ": [
          "–†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ, –∫–æ—Ç–æ—Ä—ã–º —Ç—ã –≥–æ—Ä–¥–∏—à—å—Å—è: —Ä–æ–ª—å, —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.",
          "–ß—Ç–æ —Ç–∞–∫–æ–µ SOLID ‚Äî –Ω–∞–∑–æ–≤–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏ –ø—Ä–∏–º–µ—Ä –æ–¥–Ω–æ–≥–æ –∏–∑ –Ω–∏—Ö.",
          "–ö–∞–∫ —Ç—ã —Ä–µ–∞–≥–∏—Ä—É–µ—à—å, –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏?"
        ]
      };
      const arr = bank[track] || bank["–û–±—â–µ–µ"];
      const idx = Math.min(arr.length - 1, Math.max(0, level - 1));
      demoState.difficulty = Math.min(3, demoState.difficulty + 1);
      return arr[idx];
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    function render(scrollToBottom=false){
      elChat.innerHTML = "";

      for (const m of messages){
        if (m.role === "system") continue;

        const row = document.createElement("div");
        row.className = "msg";

        const avatar = document.createElement("div");
        avatar.className = "avatar " + (m.role === "user" ? "user" : "ai");
        avatar.innerHTML = m.role === "user"
          ? "üßë"
          : "ü§ñ";

        const bubble = document.createElement("div");
        bubble.className = "bubble " + (m.role === "user" ? "user" : "ai");

        if (m.content === "__TYPING__"){
          bubble.innerHTML = `<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
        } else {
          bubble.textContent = m.content;
        }

        row.appendChild(avatar);
        row.appendChild(bubble);

        // meta (e.g., score)
        if (m.role === "assistant" && m.meta && typeof m.meta.score === "number"){
          const meta = document.createElement("div");
          meta.className = "meta";
          const s = m.meta.score;

          const badge = document.createElement("span");
          badge.className = "badge score " + (s <= 4 ? "low" : "");
          badge.textContent = "score: " + s + "/10";

          const hint = document.createElement("span");
          hint.className = "badge";
          hint.textContent = "feedback";

          meta.appendChild(badge);
          meta.appendChild(hint);
          bubble.appendChild(meta);
        }

        elChat.appendChild(row);
      }

      if (scrollToBottom){
        elChat.scrollTop = elChat.scrollHeight;
      }
    }

    function saveChat(){
      localStorage.setItem(LS_KEY, JSON.stringify(messages));
    }
    function loadChat(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }
  </script>
</body>
</html>
